name: Publish Alpha Packages

on:
  workflow_call:

jobs:
  publish-alpha:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read
      pull-requests: write
      statuses: write

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Set pending commit status
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ github.event.workflow_run.head_sha }}',
              state: 'pending',
              description: 'Publishing alpha packages...',
              context: 'alpha-publish',
              target_url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            });

      - name: Setup mise
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Extract branch name and commit SHA
        run: |
          BRANCH_NAME="${{ github.event.workflow_run.head_branch }}"
          SANITIZED_BRANCH=$(echo "$BRANCH_NAME" | sed 's/^feat\///' | sed 's/^fix\///' | sed 's/\//-/g')
          SHORT_SHA=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)
          echo "SNAPSHOT_TAG=${SANITIZED_BRANCH}-${SHORT_SHA}" >> $GITHUB_ENV

      - name: Generate changesets from commits
        run: pnpm exec tsx scripts/generate-changeset.ts -p origin/main -i HEAD

      - name: Create snapshot version
        run: pnpm exec changeset version --snapshot ${{ env.SNAPSHOT_TAG }}

      - name: Extract package versions
        id: extract-versions
        run: |
          CORE_VERSION=$(jq -r '.version' packages/core/package.json)
          SCHEMA_VERSION=$(jq -r '.version' packages/schema/package.json)
          STREAM_VERSION=$(jq -r '.version' packages/stream/package.json)
          echo "core_version=${CORE_VERSION}" >> $GITHUB_OUTPUT
          echo "schema_version=${SCHEMA_VERSION}" >> $GITHUB_OUTPUT
          echo "stream_version=${STREAM_VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted versions: core=${CORE_VERSION}, schema=${SCHEMA_VERSION}, stream=${STREAM_VERSION}"

      - name: Publish alpha packages
        run: pnpm exec changeset publish --tag alpha
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true

      - name: Notify PR and set success status
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        env:
          CORE_VERSION: ${{ steps.extract-versions.outputs.core_version }}
          SCHEMA_VERSION: ${{ steps.extract-versions.outputs.schema_version }}
          STREAM_VERSION: ${{ steps.extract-versions.outputs.stream_version }}
          HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        with:
          script: |
            const marker = '<!-- alpha-publish-comment -->';
            const coreVersion = process.env.CORE_VERSION;
            const schemaVersion = process.env.SCHEMA_VERSION;
            const streamVersion = process.env.STREAM_VERSION;
            const headSha = process.env.HEAD_SHA;
            const headBranch = process.env.HEAD_BRANCH;

            // Build comment body (no leading indentation to avoid markdown issues)
            const commentBody = [
              marker,
              '## Alpha Packages Published',
              '',
              '| Package | Version |',
              '|---------|---------|',
              `| \`@grounds/core\` | \`${coreVersion}\` |`,
              `| \`@grounds/schema\` | \`${schemaVersion}\` |`,
              `| \`@grounds/stream\` | \`${streamVersion}\` |`,
              '',
              '**Install specific version:**',
              '```bash',
              `pnpm add @grounds/core@${coreVersion}`,
              `pnpm add @grounds/schema@${schemaVersion}`,
              `pnpm add @grounds/stream@${streamVersion}`,
              '```',
              '',
              '**Or use the alpha tag (latest alpha):**',
              '```bash',
              'pnpm add @grounds/core@alpha',
              '```',
              '',
              `<sub>Published from commit ${headSha.substring(0, 7)} on branch \`${headBranch}\`</sub>`
            ].join('\n');

            // Find PR for this branch
            // Format: owner:branch for head parameter
            const headFilter = `${context.repo.owner}:${headBranch}`;
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: headFilter,
              state: 'open'
            });

            if (prs.length === 0) {
              console.log(`No open PR found for branch ${headBranch}. Skipping PR comment.`);
            } else {
              const prNumber = prs[0].number;
              console.log(`Found PR #${prNumber} for branch ${headBranch}`);

              // Find existing comment with marker
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber
              });

              const existingComment = comments.find(comment =>
                comment.body && comment.body.includes(marker)
              );

              if (existingComment) {
                console.log(`Updating existing comment ${existingComment.id}`);
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: commentBody
                });
              } else {
                console.log(`Creating new comment on PR #${prNumber}`);
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: commentBody
                });
              }
            }

            // Always set success status (even if no PR)
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: headSha,
              state: 'success',
              description: 'Alpha packages published successfully',
              context: 'alpha-publish',
              target_url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            });
            console.log('Set commit status to success');

      - name: Set failure status on error
        if: failure()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ github.event.workflow_run.head_sha }}',
              state: 'failure',
              description: 'Alpha publish failed',
              context: 'alpha-publish',
              target_url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            });
            console.log('Set commit status to failure');
