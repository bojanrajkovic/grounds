# Changesets Release Automation Design

## Overview

Automated release workflow for the grounds monorepo using Changesets, supporting both alpha (PR branches) and production (main) publishing to npm. Versions determined from conventional commits with dependency-aware bumping. OIDC trusted publishing eliminates npm token management.

**Goals:**

- Publish alpha packages on feat/_ and fix/_ branches after CI passes
- Publish production releases to npm from main branch
- Maintain version consistency across dependent packages
- Eliminate manual version management and npm token secrets

**Success criteria:**

- Alpha packages available within minutes of CI passing on PR branches
- Production releases require only merging "Version Packages" PR
- All packages maintain compatible versions based on dependency chain
- OIDC authentication works without NPM_TOKEN secret

## Architecture

Changesets manages versioning and publishing with two distinct workflows:

**Production releases (main branch):**

- `@bob-obringer/conventional-changesets` auto-generates changeset files from conventional commits
- `changesets/action` creates "Version Packages" PR with updated package.json versions and CHANGELOGs
- Merging Version Packages PR triggers publish to npm via OIDC
- Linked versioning: packages bump based on dependency chain (core → schema → stream)

**Alpha releases (feat/_ and fix/_ branches):**

- Triggered via `workflow_run` after CI passes
- Snapshot versioning generates unique versions: `{version}-{branch-name}-{shortSha}`
- Example: `0.2.0-streaming-api-abc1234`
- Publishes to npm with `@alpha` dist-tag
- All three packages publish together with same alpha version

**OIDC entry point pattern:**

- Single workflow (publish-switch.yml) registered with npm as trusted publisher
- Routes to alpha or release workflows based on trigger event
- Reusable workflows inherit OIDC permissions from switch

**Components:**

- GitHub Actions workflows: publish-switch.yml (entry), publish-alpha.yml, publish-release.yml, pr-title.yml
- Changesets configuration: `.changeset/config.json` with linked packages
- Root package.json: Changesets dependencies and scripts
- CLAUDE.md: Developer workflow documentation

## Existing Patterns

Investigation found existing CI/CD patterns from containerfile-ts repository:

**Following these patterns:**

- mise for runtime management (already in grounds)
- GitHub Actions with pnpm cache setup
- Conventional commits enforcement (already in grounds via commitlint)
- OIDC trusted publishing pattern (single entry point workflow)

**Introducing new patterns:**

- Changesets for monorepo version management (no existing release automation)
- Linked versioning for dependency-aware bumping (new to grounds)
- Auto-generation of changesets from conventional commits

**Divergence from containerfile-ts:**

- containerfile-ts uses release-please (not pnpm-friendly)
- grounds uses Changesets (better pnpm workspace support)
- containerfile-ts has single package; grounds has 3 linked packages

## Implementation Phases

### Phase 1: Install and Configure Changesets

**Goal:** Set up Changesets with linked versioning and auto-generation from conventional commits

**Components:**

- Modify: `package.json` (root) - Add devDependencies: `@changesets/cli`, `@bob-obringer/conventional-changesets`
- Create: `.changeset/config.json` - Linked versioning configuration
- Create: `.changeset/README.md` - Auto-generated by `pnpm changeset init`

**Dependencies:** None (first phase)

**Done when:**

- `pnpm install` succeeds with new dependencies
- `.changeset/` directory exists with config.json
- `pnpm exec changeset --help` works
- `pnpm exec conventional-changesets --help` works

### Phase 2: Add PR Title Validation

**Goal:** Enforce conventional commit format in PR titles (becomes commit message via squash-merge)

**Components:**

- Create: `.github/workflows/pr-title.yml`

**Dependencies:** Phase 1 (Changesets config references conventional commits)

**Done when:**

- Workflow file exists and is valid YAML
- Test PR with invalid title fails validation
- Test PR with valid conventional title passes validation

### Phase 3: Create Publishing Infrastructure

**Goal:** Set up OIDC entry point and reusable publishing workflows

**Components:**

- Create: `.github/workflows/publish-switch.yml` (OIDC entry point)
- Create: `.github/workflows/publish-alpha.yml` (reusable)
- Create: `.github/workflows/publish-release.yml` (reusable)
- Modify: `package.json` (root) - Add scripts: `changeset-version`, `release`

**Dependencies:** Phase 2 (PR title validation ensures conventional commits on main)

**Done when:**

- All three workflow files exist and are valid YAML
- `publish-switch.yml` conditionals properly route to alpha vs release
- Reusable workflows accept permissions from switch workflow
- Build succeeds with no syntax errors

### Phase 4: Configure NPM OIDC Trusted Publishers

**Goal:** Register publish-switch.yml as trusted publisher for all three packages on npmjs.com

**Components:**

- Manual configuration on npmjs.com for each package:
  - `@grounds/core`
  - `@grounds/schema`
  - `@grounds/stream`
- Trusted publisher settings:
  - Repository: `bojanrajkovic/grounds`
  - Workflow: `.github/workflows/publish-switch.yml`
  - Environment: (blank)

**Dependencies:** Phase 3 (publish-switch.yml must exist before registering)

**Done when:**

- All three packages show trusted publisher configured on npm
- Package settings page displays correct workflow path
- Test publish attempt receives OIDC token (can use `npm publish --dry-run`)

### Phase 5: Enable Alpha Publishing Workflow

**Goal:** Publish alpha packages to npm after CI passes on feat/_ and fix/_ branches

**Components:**

- Modify: `.github/workflows/ci.yml` - Ensure proper completion status for workflow_run trigger
- Test alpha publishing on real PR branch

**Dependencies:** Phase 4 (OIDC must be configured)

**Done when:**

- Create test PR on `feat/test-alpha` branch
- CI passes and triggers publish-alpha workflow
- Alpha package appears on npm with `@alpha` tag
- Version format matches `{version}-{branch-name}-{shortSha}`
- All three packages publish with same alpha version

### Phase 6: Enable Production Release Workflow

**Goal:** Publish production packages to npm when Version Packages PR merges

**Components:**

- Enable production release workflow (may be disabled during testing)
- Test full production release cycle

**Dependencies:** Phase 5 (alpha publishing validated)

**Done when:**

- Create test changeset by merging a feat/\* PR to main
- "Version Packages" PR created automatically by changesets/action
- Review PR shows updated versions and CHANGELOG entries
- Merge Version Packages PR
- Packages publish to npm with `@latest` tag
- Versions follow linked strategy (dependents bumped when dependencies change)

### Phase 7: Update Documentation

**Goal:** Document release workflow for developers and AI agents

**Components:**

- Modify: `CLAUDE.md` - Add "Changesets & Release Workflow" section after "Branch Naming"
- Modify: `README.md` - Add usage examples for installing alpha packages

**Dependencies:** Phase 6 (production releases working)

**Done when:**

- CLAUDE.md contains complete workflow documentation
- Documentation includes:
  - Conventional commit → version bump mapping
  - Alpha publishing behavior
  - Production release process
  - Installing alpha packages
- README.md updated with alpha installation examples
- Build succeeds (no broken links in docs)

## Additional Considerations

**Linked versioning behavior:**

Commit scope determines which packages bump:

- `feat(core):` → Bumps core, schema, stream (all dependents)
- `feat(schema):` → Bumps schema, stream (stream depends on schema)
- `fix(stream):` → Bumps stream only

Packages can have different versions (core@1.2.0, schema@1.1.0, stream@1.0.5) but dependencies stay compatible.

**Error handling:**

- Missing conventional commit scope: CI suggests scope from changed files
- OIDC authentication failure: Workflow fails with clear npm setup instructions
- Alpha publish failure: Does not block PR merge (alpha is informational)
- Production publish failure: Manual intervention required, can re-trigger workflow

**Future migration:**

GitHub Issue #23 tracks migration to native Changesets conventional commits support when PR #1720 merges. Current `@bob-obringer/conventional-changesets` dependency will be replaced with `changeset add --auto`.

**Version evolution:**

All packages start at 0.0.1 (pre-1.0 API). Once API stabilizes, move to 1.0.0 with strict semver enforcement. Breaking changes permitted in minor versions during 0.x phase per CLAUDE.md versioning policy.
